# 环境部署
本次部署的仿真环境为虚拟机环境。
## 1. 环境准备

- 三台机器
- 其中某一台机器安装额外网卡（这里是带有2个网口的网卡）
## 2. 架构部署
![Alt text](./img/%E6%96%B9%E6%A1%88%E9%83%A8%E7%BD%B2.svg)

## 3. 部署流程
### 1. 中间主机
- 准备工作

安装网卡，修改网卡名，关闭ipv6功能，使得两个网口失效，例如
```
sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 ipv6.disable=1"
```


`sudo ifconfig eth1 0.0.0.0`

若这一部分为虚拟机，则用Intnet内部网络创建两个网卡，然后使得两个网卡失效，且使得两个网卡开启混杂模式
具体可参考 https://blog.csdn.net/dkfajsldfsdfsd/article/details/79436716

假设创建两个intnet网络 intnet-1和intnet-2，那么主机1的网口1接入intnet-1，主机2的网口1接入intnet-2

中间的intnet相当于物理网线直连

- 安装运行mininet
```
# 安装mininent容器
docker pull daimaguicai/mn-stratum:v2.0

# 将项目中的mininet文件放置到mininet宿主机上

# 设置环境变量
alias mn-stratum="docker run --net=host --privileged -it -e DISPLAY=${DISPLAY} -v ~/projects/p4virtex/mininet:/test -v /tmp/.X11-unix:/tmp/.X11-unix --name mn-stratum --hostname mn-stratum daimaguicai/mn-stratum:v2.0"

"~/projects/p4virtex/mininet"替换成项目中mininet的安装位置

# 打开topo.py文件, 关键代码为如下
Intf("eth1",node=net.nameToNode[ "s1" ]) 
Intf("eth2",node=net.nameToNode[ "s8" ])

假设额外安装的网口为eth1和eth2，利用上面的语句就可以实现mininet的端口扩展，直接绑定主机的网口。

# 启动mininet容器
mn-stratum
cd /test
python topo.py

# 至此mininet容器已经启动，并成功绑定主机的两个网口
```

- 安装运行ONOS
```
# 安装docker容器
docker pull onosproject/onos:2.5.7

# 设置环境变量
alias onos="docker run --net=host --privileged -it --env JAVA_DEBUG_PORT='0.0.0.0:5005' --name onos onosproject/onos:2.5.7 clean debug"

# 启动onos
onos

# onos需要开启的服务
org.onosproject.netconf
org.onosproject.drivers.bmv2
org.onosproject.lldpprovider
org.onosproject.proxyarp
org.onosproject.hostprovider
org.onosproject.fwd
```

- onos 连接 mininet

在mininet文件夹下，主机端运行
`make install_netcfg`
### 2. 其他主机
目前先将直连的网卡ip设置为同一网段的IP

假设主机1的IP地址设为10.10.10.2，主机2的IP地址设为10.10.10.3

```
# 修改netplan
sudo vim /etc/netplan/01-network-manager-all.yaml
大概内容如下：
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    eth0:
      dhcp4: false
      addresses: [10.10.10.2/24]
      gateway4: 10.10.10.1

#重新启动网卡配置
sudo netplan apply
```

### 3. 测试
主机1 ping 主机2


